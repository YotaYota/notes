<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Network - Notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="network/network.html" class="active"><strong aria-hidden="true">1.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="network/letsencrypy.html"><strong aria-hidden="true">1.1.</strong> letsencrypt</a></li><li class="chapter-item expanded "><a href="network/netconf_yang.html"><strong aria-hidden="true">1.2.</strong> NETConf YANG</a></li><li class="chapter-item expanded "><a href="network/tls.html"><strong aria-hidden="true">1.3.</strong> tls</a></li></ol></li><li class="chapter-item expanded "><a href="js/js.html"><strong aria-hidden="true">2.</strong> Javascript</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="js/angular.html"><strong aria-hidden="true">2.1.</strong> angular</a></li><li class="chapter-item expanded "><a href="js/jest.html"><strong aria-hidden="true">2.2.</strong> jest</a></li><li class="chapter-item expanded "><a href="js/js.html"><strong aria-hidden="true">2.3.</strong> js</a></li><li class="chapter-item expanded "><a href="js/react.html"><strong aria-hidden="true">2.4.</strong> react</a></li></ol></li><li class="chapter-item expanded "><a href="python/main.html"><strong aria-hidden="true">3.</strong> Python</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="python/dist.html"><strong aria-hidden="true">3.1.</strong> dist</a></li></ol></li><li class="chapter-item expanded "><a href="aws/aws.html"><strong aria-hidden="true">4.</strong> AWS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="aws/api_gateway.html"><strong aria-hidden="true">4.1.</strong> API Gateway</a></li><li class="chapter-item expanded "><a href="aws/ccp.html"><strong aria-hidden="true">4.2.</strong> CCP</a></li><li class="chapter-item expanded "><a href="aws/cli.html"><strong aria-hidden="true">4.3.</strong> CLI</a></li><li class="chapter-item expanded "><a href="aws/cognito.html"><strong aria-hidden="true">4.4.</strong> Cognito</a></li><li class="chapter-item expanded "><a href="aws/dynamodb.html"><strong aria-hidden="true">4.5.</strong> DynamoDB</a></li><li class="chapter-item expanded "><a href="aws/static_website.html"><strong aria-hidden="true">4.6.</strong> Static Website</a></li><li class="chapter-item expanded "><a href="aws/iam.html"><strong aria-hidden="true">4.7.</strong> IAM</a></li><li class="chapter-item expanded "><a href="aws/lambda.html"><strong aria-hidden="true">4.8.</strong> Lambda</a></li></ol></li><li class="chapter-item expanded "><a href="linux/linux.html"><strong aria-hidden="true">5.</strong> Linux - Systemd</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/systemd.html"><strong aria-hidden="true">5.1.</strong> systemd</a></li><li class="chapter-item expanded "><a href="linux/users-groups.html"><strong aria-hidden="true">5.2.</strong> users-groups</a></li><li class="chapter-item expanded "><a href="linux/deb_pkg.html"><strong aria-hidden="true">5.3.</strong> Debian Packaging</a></li><li class="chapter-item expanded "><a href="linux/essential_tools.html"><strong aria-hidden="true">5.4.</strong> Essential Tools</a></li><li class="chapter-item expanded "><a href="linux/iproute2.html"><strong aria-hidden="true">5.5.</strong> IProute2</a></li><li class="chapter-item expanded "><a href="linux/wireguard.html"><strong aria-hidden="true">5.6.</strong> Wireguard</a></li><li class="chapter-item expanded "><a href="linux/kvm.html"><strong aria-hidden="true">5.7.</strong> KVM</a></li><li class="chapter-item expanded "><a href="linux/logging.html"><strong aria-hidden="true">5.8.</strong> Logging</a></li><li class="chapter-item expanded "><a href="linux/lutris.html"><strong aria-hidden="true">5.9.</strong> Lutris</a></li><li class="chapter-item expanded "><a href="linux/nftables.html"><strong aria-hidden="true">5.10.</strong> nftables</a></li><li class="chapter-item expanded "><a href="linux/screen.html"><strong aria-hidden="true">5.11.</strong> screen</a></li><li class="chapter-item expanded "><a href="linux/wine.html"><strong aria-hidden="true">5.12.</strong> Wine</a></li></ol></li><li class="chapter-item expanded "><a href="rust/rust.html"><strong aria-hidden="true">6.</strong> rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust/rust_web_app.html"><strong aria-hidden="true">6.1.</strong> Web App</a></li><li class="chapter-item expanded "><a href="rust/bevy.html"><strong aria-hidden="true">6.2.</strong> Bevy</a></li></ol></li><li class="chapter-item expanded "><a href="gpg.html"><strong aria-hidden="true">7.</strong> gpg</a></li><li class="chapter-item expanded "><a href="ssh.html"><strong aria-hidden="true">8.</strong> ssh</a></li><li class="chapter-item expanded "><a href="yubikey.html"><strong aria-hidden="true">9.</strong> yubikey</a></li><li class="chapter-item expanded "><a href="git.html"><strong aria-hidden="true">10.</strong> git</a></li><li class="chapter-item expanded "><a href="neovim.html"><strong aria-hidden="true">11.</strong> neovim</a></li><li class="chapter-item expanded "><a href="compdocs.html"><strong aria-hidden="true">12.</strong> compdocs</a></li><li class="chapter-item expanded "><a href="cpp.html"><strong aria-hidden="true">13.</strong> C++</a></li><li class="chapter-item expanded "><a href="docker.html"><strong aria-hidden="true">14.</strong> Docker</a></li><li class="chapter-item expanded "><a href="flatbuffers.html"><strong aria-hidden="true">15.</strong> flatbuffers</a></li><li class="chapter-item expanded "><a href="protbuf.html"><strong aria-hidden="true">16.</strong> protbuf</a></li><li class="chapter-item expanded "><a href="geojson.html"><strong aria-hidden="true">17.</strong> geojson</a></li><li class="chapter-item expanded "><a href="java.html"><strong aria-hidden="true">18.</strong> Java</a></li><li class="chapter-item expanded "><a href="jwt.html"><strong aria-hidden="true">19.</strong> JWT</a></li><li class="chapter-item expanded "><a href="kubernetes.html"><strong aria-hidden="true">20.</strong> Kubernetes</a></li><li class="chapter-item expanded "><a href="patterns.html"><strong aria-hidden="true">21.</strong> Patterns</a></li><li class="chapter-item expanded "><a href="puppet.html"><strong aria-hidden="true">22.</strong> puppet</a></li><li class="chapter-item expanded "><a href="raid.html"><strong aria-hidden="true">23.</strong> RAID</a></li><li class="chapter-item expanded "><a href="scrum.html"><strong aria-hidden="true">24.</strong> SCRUM</a></li><li class="chapter-item expanded "><a href="serverless-framework.html"><strong aria-hidden="true">25.</strong> serverless-framework</a></li><li class="chapter-item expanded "><a href="spring.html"><strong aria-hidden="true">26.</strong> Spring</a></li><li class="chapter-item expanded "><a href="sql.html"><strong aria-hidden="true">27.</strong> SQL</a></li><li class="chapter-item expanded "><a href="terraform.html"><strong aria-hidden="true">28.</strong> Terraform</a></li><li class="chapter-item expanded "><a href="clean_architecture.html"><strong aria-hidden="true">29.</strong> Clean Architecture</a></li><li class="chapter-item expanded "><a href="vocabulary.html"><strong aria-hidden="true">30.</strong> Vocabulary</a></li><li class="chapter-item expanded "><a href="work_strategy.html"><strong aria-hidden="true">31.</strong> Work Stratrgy</a></li><li class="chapter-item expanded "><a href="project.html"><strong aria-hidden="true">32.</strong> Project</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="network"><a class="header" href="#network">Network</a></h1>
<ul>
<li><code>ip link list</code></li>
<li><code>ip address show</code></li>
<li><code>ip neigh show</code> ARP table</li>
<li><code>ip route show</code></li>
</ul>
<p>Default gateway is know throught the word <strong>via</strong> in the output.</p>
<h2 id="osi"><a class="header" href="#osi">OSI</a></h2>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td><strong>Userspace</strong></td><td></td></tr>
<tr><td>Layer 7</td><td>Application</td></tr>
<tr><td>Layer 6</td><td>Presentation</td></tr>
<tr><td>Layer 5</td><td>Session</td></tr>
<tr><td><strong>Kernel</strong></td><td></td></tr>
<tr><td>Layer 4</td><td>Transport</td></tr>
<tr><td>Layer 3</td><td>Network</td></tr>
<tr><td>Layer 2</td><td>Data Link</td></tr>
<tr><td><strong>Physical</strong></td><td></td></tr>
<tr><td>Layer 1</td><td>Physical</td></tr>
</tbody></table>
</div>
<p>The 7 layer model is outdated, in preference of the 4 layer model. The only important legacy is the numbering system.</p>
<h2 id="routing-table"><a class="header" href="#routing-table">Routing Table</a></h2>
<p>A list of every Layer 3 network the router knows about and how to get there.</p>
<p><code>ip rule list</code> lists the rules.</p>
<p>By default there are 3 tables: <em>main</em>, <em>local</em> and <em>default</em>. ip tool modifies main and local.</p>
<p><code>ip route list table main</code></p>
<p>route tables are in <em>/etc/iproute2/rt_tables</em>.</p>
<p><code>ip route get &lt;ip&gt;</code> shows kernel's routing for an ip.</p>
<p>A router has a <em>Forwarding Information Base</em> (<strong>FIB</strong>) and a <em>Routing Information Base</em> (<strong>RIB</strong>). A router uses the RIB (in the <em>Control Plane</em>) to determine optimized, best routing rules.</p>
<p><strong>Note</strong>: FIB is not the same as routing table. A routing table maps IPs to a route - a FIB knows which headers to put on the packet.</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code>echo 200 John &gt;&gt; /etc/iproute2/rt_tables
</code></pre>
<p>creates a table <em>John</em>.</p>
<pre><code>ip rule add from 10.0.0.10 table John
</code></pre>
<p>creates a rule for <em>John</em> table.</p>
<p>Now <code>ip rule ls</code> will also list</p>
<pre><code>32765:	from 10.0.0.10 lookup John
</code></pre>
<h2 id="ip"><a class="header" href="#ip">IP</a></h2>
<p>These IPs are reserved for private use (<a href="https://datatracker.ietf.org/doc/html/rfc1918">RFC 1918</a>)</p>
<pre><code>     10.0.0.0        -   10.255.255.255  (10/8 prefix)
     172.16.0.0      -   172.31.255.255  (172.16/12 prefix)
     192.168.0.0     -   192.168.255.255 (192.168/16 prefix)
</code></pre>
<p>Similar for IPv6 is <a href="https://datatracker.ietf.org/doc/html/rfc4193">RFC 4193</a>.</p>
<p>loopback 127.0.0.1 address is so that the system can talk to itself and do self diagnostics.</p>
<h2 id="random-commands"><a class="header" href="#random-commands">Random commands</a></h2>
<pre><code>sudo ss -nltpu
</code></pre>
<pre><code>nstat
</code></pre>
<h2 id="dhcp"><a class="header" href="#dhcp">DHCP</a></h2>
<p>UDP, then Port 67 and 68 unicast.</p>
<ol>
<li>DHCP Discover (broadcast)</li>
<li>DHCP Offer (broadcast beacuse no ip assigned yet): network information such as client ip, subnet mask, default gateway ip, dns ip, ip lease time, dhcp server ip</li>
<li>DHCP Request: approves the ip</li>
<li>DHCP Ack (broadcast) with same information as in offer</li>
</ol>
<p>dhcpd deprecated in favor of kea.</p>
<h2 id="dns"><a class="header" href="#dns">DNS</a></h2>
<p>DNS - Domain Name System. Communicates on port 53.</p>
<p>Traditionally resolvconf, but replaced with systemd-resolved.</p>
<p>On Ubuntu <code>/etc/resolv.conf</code> is a link to <code>/run/systemd/resolve/stub-resolv.conf</code>.</p>
<p>systemd-resolved.service</p>
<pre><code>resolvectl status
</code></pre>
<p>DHCP is to dynamically get an IP. It communicates on ports 67 and 68.</p>
<p>If DHCP, then DNS server will be set automatically.</p>
<pre><code>dhclient
</code></pre>
<h3 id="letsencrypt-and-acme"><a class="header" href="#letsencrypt-and-acme">letsencrypt and ACME</a></h3>
<p>letsencrypt uses ACME protocol (<a href="https://datatracker.ietf.org/doc/html/rfc8555">RFC 8555</a>).</p>
<h2 id="network-interface"><a class="header" href="#network-interface">Network Interface</a></h2>
<p>Each connection to a node is called a "network interface". Linux gives these names like "eth0". <code>ip a</code> lists them.</p>
<p>The first of theese <code>lo</code> (loopback) represents the linux host itself.</p>
<ul>
<li><code>UP</code> means that the kernel thinks the interface is up</li>
<li><code>LOWER_UP</code> means that we have established a link at the physical layer; an electrical signal.</li>
</ul>
<h2 id="protocols"><a class="header" href="#protocols">Protocols</a></h2>
<ul>
<li>TCP</li>
<li>UDP</li>
<li>ICMP</li>
<li>BGP for updating routing tables (Bird)</li>
</ul>
<hr />
<h2 id="cs144"><a class="header" href="#cs144">CS144</a></h2>
<p>Biderectional, reliable byte stream.</p>
<p>Byte Stream Model.</p>
<p>HTTP document centric. Verbs and folder structure.</p>
<p>Packets: data and header.</p>
<p>4 layer model</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>Application</td><td>Biderectional reliable byte stream between two applications</td><td>HTTP, SMTP, SSH, FTP</td></tr>
<tr><td>Transport</td><td>Guarentees correct, in-order delivery of data end-to-end. Controls congestion</td><td>TCP, UDP, RTP</td></tr>
<tr><td>Network</td><td>Delivers datagrams end-to-end. Best-effor - no guarantees</td><td>Must use IP</td></tr>
<tr><td>Link</td><td>Delivers data over a single link</td><td>Ethernet. WiFi, DSL, 3G</td></tr>
</tbody></table>
</div>
<p>A router uses a Forwarding Table.</p>
<p><strong>Packet switching</strong>: Independently for each arriving packet, pick its outgoing link. If the link is free, send it. Else hold the packet for later.</p>
<p><strong>Flow</strong>: A collection of datagrams belonging to the same end-to-end communication.</p>
<p><strong>Connection</strong>: ?</p>
<h4 id="making-the-network-layer-work"><a class="header" href="#making-the-network-layer-work">Making the Network Layer Work</a></h4>
<ol>
<li>The IP protocol
<ul>
<li>Creation of IP datagrams</li>
<li>hop-by-hop delivery from end to end</li>
</ul>
</li>
<li>Routing Tables
<ul>
<li>Algorithm to populate forwarding tables</li>
</ul>
</li>
<li>ICMP
<ul>
<li>Communicates network layer information between end hosts and routers</li>
<li>Reports error conditions</li>
<li>Helps in diagnosing problems</li>
</ul>
</li>
</ol>
<h3 id="ip-1"><a class="header" href="#ip-1">IP</a></h3>
<ul>
<li>Datagram</li>
<li>Unreliable</li>
<li>Best effort</li>
<li>Connectionless</li>
</ul>
<p>IP makes no guarantees; that is the concern of the transport layer.</p>
<p>IP Service Model:</p>
<ol>
<li>Tries to prevent looping forever (TTL)</li>
<li>Will fragments if they are too long</li>
<li>Uses a header checksum to reduce chances od delivering datagram to wrong destination</li>
<li>Allows for new versions of IP</li>
<li>Allows for new options to be added to header</li>
</ol>
<pre><code>Bit 0
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                   (Options)                   |   (Padding)   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
IPv4 Datagram

IHL: Header Length
</code></pre>
<h3 id="principle-layering"><a class="header" href="#principle-layering">Principle: Layering</a></h3>
<p>Is the name we give to the organization of the system into a number of functional components or "layers".
Layers are hiearchial and communicate sequentially. Ie, each layer has only an interface to the layer directly above/below.</p>
<p>Each layer provides a service and abstracts it in an interface for the layers above.</p>
<p>Layering creates</p>
<ul>
<li>enables modularity (breaks down into smaller more manageable modules)</li>
<li>well-defined service (provides interface towards layer above)</li>
<li>reuse (layers below can be reused)</li>
<li>separation of concerns (caring about its own job without caring how other layers do theirs)</li>
<li>continuous improvement</li>
</ul>
<h3 id="principle-encapsulation"><a class="header" href="#principle-encapsulation">Principle: Encapsulation</a></h3>
<p>When combining layering and packet switching.</p>
<h3 id="endianess"><a class="header" href="#endianess">Endianess</a></h3>
<ul>
<li><strong>LSB</strong> Least Significant Byte or Little-Endian</li>
<li><strong>MSB</strong> Most Significant Byte or Big-Endian</li>
</ul>
<p>Network packets are Big-Endian.</p>
<h3 id="netmask"><a class="header" href="#netmask">Netmask</a></h3>
<p>Netmasks tells you witch IPs are local, or if packets needs to go through a router.</p>
<p><strong>CIDR</strong> Classless Inter-Domain Routing has powers of 2.</p>
<p>IANA is responsible of giving out /8s to RIRs.</p>
<h3 id="router"><a class="header" href="#router">Router</a></h3>
<p>A router have many links. To devcide on which link to forward packets, it uses <em>Longest Prefix Match</em>.
This is used to decide which link to take in a <strong>Forwarding Table</strong>. A Forwarding Table consists of two parts: a CIDR entry, and a <em>next-hop</em> for that CIDR entry.
The <em>default</em> route is the least specific match.</p>
<h3 id="arp"><a class="header" href="#arp">ARP</a></h3>
<p>Hosts needs to keep a mapping between MAC address and IP address.</p>
<h3 id="tcp"><a class="header" href="#tcp">TCP</a></h3>
<p>3-way-handshake:</p>
<ol>
<li>SYN</li>
<li>SYN + ACK</li>
<li>ACK</li>
</ol>
<p>A stream of bytes are delivered using TCP segments.</p>
<p>Teardown:</p>
<ol>
<li>A sends FIN to B</li>
<li>B continues to send Data + ACK (if it needs to)</li>
<li>B sends FIN</li>
<li>A sends ACK</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Behavior</th></tr></thead><tbody>
<tr><td>Stream of bytes</td><td>Reliable byte delivery service</td></tr>
<tr><td>Reliable delivery</td><td><ol><li>ACK indicate correct delivery<li>Checksums detect corrupted data<li>Sequence numbers detect missing data<li>Flow-control prevents overriding reciever</ol></td></tr>
<tr><td>In-sequence</td><td>Data delivered to application in sequence transmitted</td></tr>
<tr><td>(Congestion Control)</td><td>Controls network congestion</td></tr>
</tbody></table>
</div>
<pre><code> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |       |C|E|U|A|P|R|S|F|                               |
| Offset| Rsrvd |W|C|R|C|S|S|Y|I|            Window             |
|       |       |R|E|G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           [Options]                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               :
:                             Data                              :
:                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
TCP packet
</code></pre>
<p>The 5-tuple: (src addr, src port, dst port, dps addr, protocol) is a globally unique identifier of the connection. There is however a small chance that it could overlap a previous connection that has lingered on the net (eg in a router's buffer), therefore TCP also sends an initial sequence number (ISN) to minimize the chance of an ID-overlap.</p>
<h3 id="udp"><a class="header" href="#udp">UDP</a></h3>
<pre><code> 0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|     Source      |   Destination   |
|      Port       |      Port       |
+--------+--------+--------+--------+
|                 |                 |
|     Length      |    Checksum     |
+--------+--------+--------+--------+
|
|          data octets ...
+---------------- ...

     User Datagram Header Format
</code></pre>
<p>UDP checksum includes pieces of information from the IP layer, thus violating the layering principle. The upshot is that that UDP protocol can detect if datagrams were delivered to the wrong destination.</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Behavior</th></tr></thead><tbody>
<tr><td>Connectionless Datagram Service</td><td>No connection established. Packets may show up in any order.</td></tr>
<tr><td>Self contained datagrams</td><td></td></tr>
<tr><td>Unreliable delivery</td><td><ol><li>no ACK<li>No mechanism to detect missing or mis-sequenced datagrams<li>No Flow-control</ol></td></tr>
</tbody></table>
</div>
<p>UDP prvides a simple datagram serice between processes. It is mostly used in cases where the datagram is self contained, eg DNS, NTP and DHCP.</p>
<h3 id="icmp"><a class="header" href="#icmp">ICMP</a></h3>
<p>Internet Control Message Protocol.</p>
<p>Transport layer protocol.</p>
<p>Used by ping and traceroute.</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Behavior</th></tr></thead><tbody>
<tr><td>Reporting Message</td><td>Self-contained message reporting error</td></tr>
<tr><td>Unreliable</td><td>Simple datagram service - no retries</td></tr>
</tbody></table>
</div>
<h4 id="traceroute"><a class="header" href="#traceroute">Traceroute</a></h4>
<p>ICMP error message data takes the IP header and the first 8 bites of the IP payload. It then adds the headers Type and Code.</p>
<p>Client sends an UDP message with TTL set to 1. The next hop will return an ICMP message with the IP headers and the first 8 bytes of the original message - this information is enough for the client to figure out which was the original UDP message.
The client continues to do this with increasing TTL.
When reaching the host the client has deliberately chosen a strange port, so that the host will return an ICMP message "port unreachable".</p>
<h3 id="end-to-end-principle"><a class="header" href="#end-to-end-principle">End-to-End Principle</a></h3>
<p>First described by Saltzer, Reed and Clark in 1984.
Two principles: Weak and Strong.</p>
<p>The weak principle says that the network can only provide extra features if it has information about what the endpoints wants to achieve. Eg security can only be done correctly if the end applications does it.</p>
<p>The string principle says that nothing extra should be done in the network.
"The network's job is to transmit datagrams as efficiently and flexibly as possible. Eerything else should be done at the fringes..." - RFC 1958</p>
<p>The Strong End-to-End Principle makes extending network is easier (SOLID).</p>
<h3 id="error-detection-3-schemes"><a class="header" href="#error-detection-3-schemes">Error Detection: 3 schemes</a></h3>
<p>At a hight level, error detection bits are calculated over the payload data, and is then appended or prepended to the payload.</p>
<p>Networks in general uses 3 different error detection algorithms:</p>
<ul>
<li>Checksums adds up all the bytes (TCP and IP)
<ul>
<li>fast and easy to compute</li>
<li>not robust</li>
</ul>
</li>
<li>CRC, Cyclic Recundancy Codes (Ethernet)
<ul>
<li>A CRC of length c can detect any 2 bit errors, any burst of errors &lt; c bits long, any odd number of errors.</li>
</ul>
</li>
<li>MAC, Message Authentication Codes (TLS)
<ul>
<li>combines the message with some secret information to generate a value</li>
<li>robust to malicious modifications</li>
<li>any 2 messages have 2^(-c) chance of having the same code</li>
<li>Ceyptographically strong; not good for detection errors</li>
</ul>
</li>
</ul>
<h3 id="finite-state-machine-fsm"><a class="header" href="#finite-state-machine-fsm">Finite State Machine (FSM)</a></h3>
<p>Commonly used when specifying network protocols and systems.</p>
<p>A <strong>state</strong> is a particular configuration of the system. The system can only be in 1 state.</p>
<p><strong>Edges</strong> define how to transition between states. It includes information about <em>events</em> causing state transition, and <em>actions</em> taken on state transition.</p>
<p><img src="img/fsm_tcp_connection.png" alt="FSM for TCP Connection" /></p>
<h3 id="flow-control"><a class="header" href="#flow-control">Flow Control</a></h3>
<p>Don't send more packets than receiver can process. Receiver gives sender feedback.</p>
<p>Two basic approaches:</p>
<ul>
<li>Stop and wait</li>
<li>Sliding window</li>
</ul>
<h4 id="stop-and-wait"><a class="header" href="#stop-and-wait">Stop and Wait</a></h4>
<p>At most 1 packet in flight at any time.</p>
<p>Reciever recieves data and sends ACK.
Sender sends data, then waits for ACK until sending next. If no ACK is received until a timeout, it sends the packet again.</p>
<p>A bad scenario is if the ACK get received after the timeout, which triggers both a resend, and a send of new data. If one of those messages gets lost, and only one ACK is received from those, this could result in duplicates.</p>
<p>1-bit counter is an approach to handle this scenario, but it is only reliable if the network does not duplicate the package and packets are not delayed multiple timouts.</p>
<h4 id="sliding-window"><a class="header" href="#sliding-window">Sliding Window</a></h4>
<ul>
<li>A generalization of stop-and-wait: allow multiple un-acked segments.</li>
<li>Bound on number of un-acked segments, called <strong>window</strong>.</li>
<li>Sliding Window can keep the pipe full, ie utilizing the receiver's full potential.</li>
<li>Uses <em>cumulative acknowledgments</em>.
For sender:</li>
</ul>
<p>Every segment has a sequence number <strong>SeqNo</strong>.</p>
<p>Sender maintains 3 variables:</p>
<ul>
<li><strong>SWS</strong>: Send Window Size</li>
<li><strong>LAR</strong>: Last Acknowledgment Received</li>
<li><strong>LSS</strong>: Last Segment Sent</li>
</ul>
<p>Sender maintains the invariant</p>
<pre><code>(LSS - LAR) =&lt; SWS
</code></pre>
<p>Sender advances LAR on new acknowledgment. It cannot send LSS greater than SWS + LAR.</p>
<p>Receiver maintains 3 variables:</p>
<ul>
<li><strong>RWS</strong>: Received Window Size</li>
<li><strong>LAS</strong>: Last Acceptable Segment</li>
<li><strong>LSR</strong>: Last Segment Received</li>
</ul>
<p>Recceiver maintains the invariant</p>
<pre><code>(LAS - LSR) =&lt; RWS
</code></pre>
<p>If received packet is &lt; LAS, send cumulative acknowledgment (ie not always the last received, but the cumulativevly last received).</p>
<p><strong>Note</strong>: TCP is a sliding window protocol, but ACKs are instead next expected data, ie LAS + 1</p>
<h3 id="retransmission-strategies"><a class="header" href="#retransmission-strategies">Retransmission Strategies</a></h3>
<p>Essentially 2 strategies:</p>
<ul>
<li><strong>Go-back-N</strong>: one loss will lead to entire window retransmitting (pessimistic)</li>
<li><strong>Selective Repeat</strong>: one loss will lead to only that packet retransmitting (optimistic)</li>
</ul>
<h3 id="tcp-header"><a class="header" href="#tcp-header">TCP Header</a></h3>
<p>Standard TCP header is 20 bytes long.</p>
<p><em>checksum</em>: includes part of the IP header.</p>
<p>Flags:</p>
<ul>
<li>CWR + ECE: used warn senders of congestion thereby avoiding packet drops and retransmissions.</li>
<li>URG: Urgent</li>
<li>ACK: Acknowldegment</li>
<li>PSH: Push</li>
<li>RST: Reset to sequence number</li>
<li>SYN: Synchronize sequence number</li>
<li>FIN: For teardown</li>
</ul>
<h3 id="tcp-setup-and-teardown"><a class="header" href="#tcp-setup-and-teardown">TCP Setup and Teardown</a></h3>
<ul>
<li>3-way-handshake</li>
<li>simultaneous open</li>
<li>TCP state machine</li>
</ul>
<p>Having state on both ends turns out to be more efficient.</p>
<p><strong>3-way-handshake</strong></p>
<ol>
<li>Active opener sends a packet with the SYN bit set with a sequence number (often randomized).</li>
<li>Passive opener responds with SYN with a sequence number, it also ACKs the openers sequence number.</li>
<li>Active opener responds its sequence number + 1 and ACKs passive openers sequnce number.</li>
</ol>
<p><strong>Simultaneous open</strong></p>
<p>Both clientes know each other's port number.</p>
<ol>
<li>Both sides send SYN and sequence number at the same time.</li>
<li>Both sides ACKs the others sequence number</li>
</ol>
<p><strong>Note</strong>: Simultaneous open takes 4 messages, rather than 3.</p>
<p><strong>Teardown</strong></p>
<p>FIN means the sender has no more data to send. But the connection is not closed until both sides has sent a FIN.</p>
<ol>
<li>FIN and ACKs prevoius data</li>
<li>FIN and ACKs the fin</li>
<li>ACKs the fin</li>
</ol>
<p>To avoid problems if either the final ACK gets lost or the same port pair is reused, the active closer goes into <strong>TIME WAIT</strong>. It keeps the socket for twice the "maximum segment lifetime".</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next prefetch" href="network/letsencrypy.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next prefetch" href="network/letsencrypy.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
